<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy Cake</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lora:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // ========================
    // Componente de Produto
    // ========================
    function ProductCard({ product }) {
      const [comments, setComments] = useState(product.comments || []);
      const [text, setText] = useState("");
      const [rating, setRating] = useState(5);

      const handleComment = () => {
        if (!text) return alert("Digite um comentário!");

        fetch(`http://localhost:5000/cakes/${product.id}/comments`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user: "Cliente Anônimo", text, rating })
        })
          .then(res => res.json())
          .then(comment => {
            setComments([...comments, comment]);
            setText("");
            setRating(5);
          })
          .catch(err => console.error("Erro ao comentar:", err));
      };

      return (
        <div className="product-card">
          <img src={product.image} alt={product.name} />
          <div className="info">
            <h3>{product.name}</h3>
            <p className="price">R$ {product.price.toFixed(2)}</p>
            <p className="description">{product.description}</p>

            {/* Formulário de comentário */}
            <div className="comment-form">
              <h4>Deixe sua avaliação</h4>
              <select value={rating} onChange={e => setRating(Number(e.target.value))}>
                <option value={1}>⭐</option>
                <option value={2}>⭐⭐</option>
                <option value={3}>⭐⭐⭐</option>
                <option value={4}>⭐⭐⭐⭐</option>
                <option value={5}>⭐⭐⭐⭐⭐</option>
              </select>
              <textarea
                placeholder="Escreva seu comentário..."
                value={text}
                onChange={e => setText(e.target.value)}
              ></textarea>
              <button onClick={handleComment}>Enviar</button>
            </div>

            {/* Lista de comentários */}
            <div className="comments">
              <h4>Comentários</h4>
              {comments.length === 0 ? (
                <p>Seja o primeiro a comentar!</p>
              ) : (
                comments.map((c, i) => (
                  <p key={i}><strong>{c.user}</strong> ({c.rating}⭐): {c.text}</p>
                ))
              )}
            </div>
          </div>
        </div>
      );
    }

    // ========================
    // Componente Principal
    // ========================
    function App() {
      const [products, setProducts] = useState([]);

      // Carregar bolos do back-end
      useEffect(() => {
        fetch("http://localhost:5000/cakes")
          .then(res => res.json())
          .then(data => setProducts(data))
          .catch(err => console.error("Erro ao buscar bolos:", err));
      }, []);

      return (
        <main>
          <h1>Buy Cake - Sua confeitaria virtual!</h1>
          <div className="products">
            {products.map(p => (
              <ProductCard key={p.id} product={p} />
            ))}
          </div>
        </main>
      );
    }

    // Renderizar
    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
